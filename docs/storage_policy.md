# 스토리지 및 데이터 저장 정책 (Storage Policy)

Pickle은 사용자에게 제한된 자원을 공정하고 효율적으로 제공하기 위해 통합 스토리지 용량 관리 정책을 시행합니다. 본 문서는 기술적 구현 상세와 운영 정책을 설명합니다.

---

## 1. 정책 개요
사용자는 워크스페이스별로 정해진 용량 한도 내에서 데이터를 저장할 수 있습니다. 한도는 파일(이미지, 캡처)뿐만 아니라 DB에 저장되는 텍스트 및 북마크 데이터의 실제 크기를 모두 포함합니다.

- **기본 한도**: 50MB (기본값)
  - 이 상수들은 `@pickle/contracts/src/storage.ts`에 정의되어 관리됩니다.
- **대상 데이터**: 
  - **Assets**: 원본 파일 및 썸네일 (Storage 점유)
  - **Notes**: 텍스트 본문, 메타데이터, 북마크 정보 (DB 점유)

---

## 2. 용량 계산 방식
정확한 사용량 산출을 위해 추정치가 아닌 실제 점유 바이트(Bytes)를 기준으로 계산합니다.

### 2.1 파일 용량 (Assets)
`assets` 테이블에 기록된 `full_size_bytes`와 `thumb_size_bytes`의 합계를 계산합니다.

### 2.2 데이터 용량 (Notes/Bookmarks)
PostgreSQL의 `pg_column_size()` 함수를 사용하여 `notes` 테이블의 각 row가 DB 상에서 실제로 차지하는 디스크 바이트 크기를 측정합니다.
- **북마크**: URL, 제목, 설명, 파비콘 등 북마크 타입 노트의 전체 크기
- **텍스트**: 일반 노트 및 캡처 메모의 텍스트 데이터 크기

### 2.3 통합 계산 (RPC)
성능과 정확도를 위해 서버 사이드(PostgreSQL RPC)에서 위 항목들을 합산하여 반환합니다.
- **함수명**: `get_workspace_storage_info(p_workspace_id)`
- **반환 구조 (`WorkspaceStorageUsage`)**:
  - `asset_bytes`: 파일 데이터 총합
  - `bookmark_bytes`: 북마크 타입 데이터 총합
  - `text_bytes`: 텍스트 타입 데이터 총합
  - `total_used_bytes`: 위 3개 항목의 총합
  - `limit_bytes`: 워크스페이스에 할당된 한도

---

## 3. 저장 및 차단 로직
저장 시점에 실시간으로 잔여 용량을 체크하며, 한도 초과 시 데이터 무결성을 위해 저장을 차단합니다.

- **체크 시점**:
  - 확장프로그램: 이미지/캡처/텍스트 저장 전
  - 웹: 노트 생성 및 수정 시 (예정)
- **차단 기준**: `현재 사용량 + 업로드할 파일/데이터 크기 > 워크스페이스 한도`
- **사용자 알림**: 용량 초과 시 "스토리지 용량이 부족합니다"라는 피드백과 함께 현재 사용량/한도를 안내합니다.

---

## 4. 모니터링 및 시각화
사용자가 용량을 직관적으로 관리할 수 있도록 UI를 제공합니다.

- **통합 게이지**: 헤더에서 전체 사용량 %를 프로그레스 바 형태로 노출
- **경고 상태**: 한도의 **90% 이상** 사용 시 게이지 색상을 주황색으로 변경하여 주의 환기
- **상세 내역**: 프로필 패널에서 이미지, 북마크, 텍스트별 점유 비중을 분리하여 표시

---

## 5. 관리자 가이드 (가변 한도 수정)
워크스페이스별로 한도를 수정하려면 DB의 `workspaces` 테이블에서 직접 조정이 가능합니다.

```sql
-- 특정 워크스페이스의 한도를 100MB로 상향
UPDATE workspaces 
SET storage_limit_bytes = 104857600 -- 100 * 1024 * 1024
WHERE id = 'workspace-uuid';
```

---

## 6. 기술적 주의사항
- **단위 일관성**: 모든 비즈니스 로직과 비교는 **Byte(정수)** 단위를 사용합니다. (부동소수점 오차 방지)
- **단위 변환**: 사용자에게는 `formatBytes` 유틸리티를 사용하여 KB, MB 등 최적의 단위로 변환하여 표시합니다.
