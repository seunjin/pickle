# Pickle Extension 아키텍처 및 동작 원리 (Technical Deep-Dive)

본 문서는 Pickle 크롬 익스텐션의 내부 구조, 멀티 프레임(iframe) 대응 전략, 백그라운드 기반 상태 동기화 및 안정적인 통신 시스템에 대한 기술적 세부 사항을 다룹니다.

---

## 1. 멀티 프레임(iframe) 통합 이벤트 모델

Pickle은 네이버 블로그와 같이 메인 콘텐츠가 `iframe` 내부에 위치한 복잡한 웹 페이지에서도 일관된 사용자 경험을 제공하기 위해 **프레임 분산 감지 및 중앙 집중 제어** 모델을 채택합니다.

### 1-1. 전역 스크립트 주입 (All-Frames Injection)
- `manifest.json`에서 `all_frames: true`를 설정하여 최상위 도큐먼트뿐만 아니라 모든 `iframe` 내부에 컨텐트 스크립트를 주입합니다.
- 이를 통해 사용자가 어느 프레임에 포커스를 두고 있더라도 단축키 이벤트를 즉시 포착할 수 있습니다.

### 1-2. 중앙 집중식 UI 마운팅 (Top Frame Rendering)
- 단축키 감지는 모든 프레임에서 수행되지만, 오버레이 UI는 반드시 **최상위 프레임(`window === window.top`)**에서만 렌더링됩니다.
- **로직**: `iframe`에서 단축키가 발생하면 백그라운드에 메시지를 보내고, 백그라운드는 해당 탭의 최상위 프레임으로 오버레이 마운트 명령을 전달하거나 응답(Response)을 통해 최상위 프레임에서 직접 마운트하도록 유도합니다.

---

## 2. 백그라운드 코디네이션 레이어 (State Synchronization)

서로 다른 프레임 간의 독립적인 상태(예: 어떤 이미지에 호버했는지)를 동기화하기 위해 백그라운드 서버 워커가 **전역 상태 조정자(State Coordinator)** 역할을 수행합니다.

### 2-1. `tabHoverCache` 시스템
- **데이터 흐름**:
  1. 컨텐트 스크립트(`mouseover`): 사용자가 이미지 위에 마우스를 올리면, 해당 프레임은 이미지 정보(`src`, `alt`)를 백그라운드로 즉시 전송합니다.
  2. 백그라운드: 탭 ID(`tabId`)를 키로 하여 호버된 이미지 정보를 메모리 캐시에 저장합니다.
- **효과**: 사용자가 `iframe` 내의 이미지를 호버한 후, 키보드 포커스가 다른 프레임으로 이동하더라도 단축키 입력 시 백그라운드 캐시를 참조하여 '최근에 호버했던' 대상을 정확히 저장할 수 있습니다.

---

## 3. 통신 복구 및 안정성 패턴 (`safeSendMessage`)

익스텐션의 수명 주기(Update, Context Invalidation)와 데이터 직렬화 특성으로 인한 런타임 크래시를 방지하기 위해 확장된 통신 패턴을 적용했습니다.

### 3-1. 자가 진단 및 직렬화 보장
- **Context Validation**: 메시지 전송 전 `chrome.runtime.id`를 확인하여 익스텐션 컨텍스트가 무효화된 경우(예: 업데이트 후 새로고침 안 함) 사용자에게 페이지 새로고침을 안내합니다.
- **Deep Serialization**: 메시징 도중 발생할 수 있는 비직렬화 데이터(Circular Reference 등) 문제를 원천 차단하기 위해 전송 전 `JSON.parse(JSON.stringify())`를 통한 딥 클론을 수행합니다.

---

## 4. 시점 전환 기반 메타데이터 추출 (Pivot Extraction)

기존의 "저장 후 나중에 추출" 방식에서 발생하는 데이터 유실을 막기 위해 **푸시 기반 선제 추출**로 전환했습니다.

1. **선제적 수집**: 단축키(`keydown`)가 눌린 시점에 해당 프레임에서 즉시 `og:image`, `favicon`, `title` 등의 메타데이터를 추출합니다.
2. **동시 전달**: 저장 요청 메시지에 수집된 메타데이터를 동봉(Push)하여 보냄으로써, 백그라운드가 나중에 TOP 프레임에 다시 물어볼 필요 없이(Pull 제거) 즉시 완전한 데이터셋을 DB에 저장할 수 있습니다.

---

## 5. 빌드 시스템 최적화 (Stable Deployment)

크롬 익스텐션의 배포 안정성을 위해 빌드 파이프라인(`vite.config.ts`)을 최적화했습니다.

- **안정적 파일명 (Fixed Filenames)**: Vite의 기본값인 해시 파일명 대신 고정된 파일명을 생성합니다. 이는 런타임에 동적으로 로드되는 청크(Chunk)들이 배포 시 해시 변경으로 인해 '파일을 찾을 수 없음(`ERR_FILE_NOT_FOUND`)' 에러를 일으키는 것을 방지합니다.

---

## 6. 데이터 접근 및 보안 (Direct DB Access)

보안과 성능의 균형을 위해 권한 체계를 다음과 같이 구성합니다:

- **Background Direct DB Access**: 모든 DB 쓰기 로직은 백그라운드에서만 수행됩니다. 이는 `access_token` 등 민감한 인증 정보가 컨텐트 스크립트(웹페이지 공격에 노출될 수 있는 영역)에 노출되는 것을 차단하기 위함입니다.
- **Security Group**: `supabase-js` 클라이언트를 백그라운드에 상주시키고, RLS(Row Level Security) 정책을 통해 사용자별 접근 권한을 철저히 격리합니다. 
